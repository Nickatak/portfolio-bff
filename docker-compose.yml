name: portfolio-bff

services:
  mysql:
    image: mysql:8.0
    ports:
      - "${PORTFOLIO_BFF_DB_PORT:-3306}:3306"
    environment:
      MYSQL_DATABASE: ${DB_NAME:-portfolio_bff}
      MYSQL_USER: ${DB_USER:-portfolio}
      MYSQL_PASSWORD: ${DB_PASSWORD:-portfolio}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-portfolio}
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -p$${MYSQL_ROOT_PASSWORD} --silent"]
      interval: 5s
      timeout: 5s
      retries: 20

  bff:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${PORTFOLIO_BFF_PORT:-8001}:8000"
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      DB_NAME: ${DB_NAME:-portfolio_bff}
      DB_USER: ${DB_USER:-portfolio}
      DB_PASSWORD: ${DB_PASSWORD:-portfolio}
      DB_HOST: ${DB_HOST:-mysql}
      DB_PORT: ${DB_PORT:-3306}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1,portfolio-bff}
      CSRF_TRUSTED_ORIGINS: ${CSRF_TRUSTED_ORIGINS:-}
      USE_X_FORWARDED_HOST: ${USE_X_FORWARDED_HOST:-}
      USE_X_FORWARDED_PROTO: ${USE_X_FORWARDED_PROTO:-}
      BFF_DEV_SUPERUSER_USERNAME: ${BFF_DEV_SUPERUSER_USERNAME:-test@ex.com}
      BFF_DEV_SUPERUSER_EMAIL: ${BFF_DEV_SUPERUSER_EMAIL:-admin@example.com}
      BFF_DEV_SUPERUSER_PASSWORD: ${BFF_DEV_SUPERUSER_PASSWORD:-Qweqwe123}
    command:
      - sh
      - -c
      - |
          until python manage.py migrate; do
            echo "waiting for mysql..."
            sleep 1
          done
          python manage.py runserver 0.0.0.0:8000
    networks:
      default:
        aliases:
          - portfolio-bff

  consumer:
    build:
      context: .
      dockerfile: Dockerfile
    command:
      - sh
      - -c
      - |
          until python manage.py migrate --check; do
            echo "waiting for migrations..."
            sleep 1
          done
          python manage.py consume_appointments
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      DB_NAME: ${DB_NAME:-portfolio_bff}
      DB_USER: ${DB_USER:-portfolio}
      DB_PASSWORD: ${DB_PASSWORD:-portfolio}
      DB_HOST: ${DB_HOST:-mysql}
      DB_PORT: ${DB_PORT:-3306}
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:19092}
      KAFKA_TOPIC_APPOINTMENTS_CREATED: ${KAFKA_TOPIC_APPOINTMENTS_CREATED:-appointments.created}
      KAFKA_CONSUMER_GROUP: ${KAFKA_CONSUMER_GROUP:-portfolio-bff}
      KAFKA_AUTO_OFFSET_RESET: ${KAFKA_AUTO_OFFSET_RESET:-latest}
    networks:
      - notifier
      - default

  admin-ui:
    image: node:20-alpine
    working_dir: /app
    command:
      - sh
      - -c
      - npm ci && npm run dev -- --hostname 0.0.0.0
    ports:
      - "${PORTFOLIO_BFF_ADMIN_UI_PORT:-3001}:3001"
    environment:
      NEXT_PUBLIC_BFF_BASE_URL: ${NEXT_PUBLIC_BFF_ADMIN_BFF_BASE_URL:-http://localhost:8001}
    volumes:
      - ./admin-ui:/app
      - admin_ui_node_modules:/app/node_modules
    networks:
      - default

networks:
  default:
    name: portfolio_net
  notifier:
    external: true
    name: notifier_service_default

volumes:
  mysql_data:
  admin_ui_node_modules:
